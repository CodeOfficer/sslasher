#!/usr/bin/env ruby -wKU

require "fileutils"
require "erb"

	USR_HOME           = "#{ `echo $HOME` }".strip
	USR_SSL_CSR        = "#{ USR_HOME }/.ssl/sslasher.csr"
	USR_SSL_KEY        = "#{ USR_HOME }/.ssl/sslasher.key"

	GEM_DIR            = File.expand_path("../..", __FILE__)
	GEM_NGINX_CONFIG   = "#{ GEM_DIR }/templates/sslasher.conf.erb"
	GEM_SSL_CSR        = "#{ GEM_DIR }/certificate/sslasher.csr"
	GEM_SSL_KEY        = "#{ GEM_DIR }/certificate/sslasher.key"

	APP_ROOT           = "#{ `pwd` }".strip
	PID_FILE           = "#{ APP_ROOT }/tmp/pids/nginx.pid"

	CONFIG_FILE        = "/tmp/sslasher.conf"

unless FileTest.exists?(USR_SSL_CSR) && FileTest.exists?(USR_SSL_KEY)
	FileUtils.mkdir_p "#{ USR_HOME }/.ssl"
	FileUtils.copy(GEM_SSL_CSR, USR_SSL_CSR)
	FileUtils.copy(GEM_SSL_KEY, USR_SSL_KEY)
end


args = ARGV.join(' ')
command  = "sudo nginx -c #{CONFIG_FILE} #{args}"

puts "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"
	if FileTest.exists?(PID_FILE)
		command  = "#{command} -s stop"
		puts "Now quiting the server with:"
		puts
		puts "#{command}"

	else
		puts "Which port would you like NGINX to proxy to?"
		$stdout.write "[3000]: "
		asked_port = gets
		PROXY_PORT = asked_port.strip.empty? ? '3000' : asked_port
		puts

		USER = "#{`id -un`}".strip
		GROUP = "#{`id -gn`}".strip
		CONFIG = "#{ `nginx -V 2>&1` }".strip
		NGINX_CONFIG_DIR = /--conf-path=(\S*)\/nginx.conf/.match(CONFIG)[1] || "/usr/local/etc/nginx"
		NGINX_MIME_FILE = "#{NGINX_CONFIG_DIR}/mime.types"

		file_out = File.open(CONFIG_FILE, "w") do |f|
			f.puts ERB.new(File.read(GEM_NGINX_CONFIG)).result(binding)
		end

		puts "We need to give NGINX sudo access so it can bind to ports"
		puts "80 for HTTP and 443 for HTTPS. We'll then proxy both of those"
		puts "ports to your app server. Don't worry, it won't run as root."
		puts
		puts "Now starting the server with:"
		puts
		puts "#{command}"
	end
puts "~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~~"

`#{command}`
